library(tidyverse)
library(magrittr)
library(sf)
People <- read_delim(
"Mexico OD Survey/eod_2017_csv/tsdem_eod2017/conjunto_de_datos/tsdem.csv",
delim = ",")
Trips <- read_delim(
"Mexico OD Survey/eod_2017_csv/tviaje_eod2017/conjunto_de_datos/tviaje.csv",
delim = ",")
#p5_11: HomeTrip or not
#p5_13: Trip Purpose
#p5_9_1: Time the trip started
PurposeNames <- data.frame(p5_13 = c(1:10,99),
Purpose = c("Hogar","Trabajar", "Estudiar",
"Otro", "Recreacion","Otro", "Otro",
"Salud", rep("Otro",3)))
ModesNames <- data.frame(p5_14 = seq(1:20),
Modes = c("Automovil", "Colectivo/Micro", "Taxi(App internet)",
"Taxi (sitio, calle u otro)", "Metro", "Autobús RTP o M1",
"Bicicleta",  "Autobus", "Moto",  "Trolebus",
"Metrobus o Mexibus", "Tren ligero","Tren suburbano",
"Caminar en la calle", "Mexicable", "Bicitaxi",  "Mototaxi",
"Transporte escolar", "Transporte de personal", "Otro"))
TripsStages <- read_delim(
"Mexico OD Survey/eod_2017_csv/ttransporte_eod2017/conjunto_de_datos/ttransporte.csv",
delim = ",")
# id_via is the unique identifier. It is consistent with Trips
# p5_14 is the transport mode
# p5_16 is the order of the stages.
Home <- read_delim(
"Mexico OD Survey/eod_2017_csv/thogar_eod2017/conjunto_de_datos/thogar.csv",
delim = ",")
Zones <- st_read("Mexico OD Survey/DistritosEODHogaresZMVM2017/DistritosEODHogaresZMVM2017.shp")
ZonesStations <- st_read("GTFS_March_2017/ZonesStations.shp")
ZonesStations %<>% st_set_geometry(NULL) %>% select(Distrito, NUMPOINTS)
names(ZonesStations) <- c("distrito", "Stations")
dim(Trips)
dim(TripsStages)
dim(Home)
dim(People)
TripsStages2 <- TripsStages %>%
select(id_via, Mode = p5_14,
TT_Hours = p5_16_1_1, TT_Minutes = p5_16_1_2) %>%
mutate(TT_Hours = as.numeric(TT_Hours),
TT_Minutes = as.numeric(TT_Minutes)) %>%
filter(!TT_Hours == 99) %>% filter(!TT_Minutes == 99) %>%
filter(TT_Hours < 4) %>%  # Remove trips lasting more than 4 hours.
mutate(TravelTime = TT_Hours*60 + TT_Minutes)
View(TripsStages2)
View(TripsStages2)
View(TripsStages2)
Temp_UniqueTrips <- TripsStages2 %>% group_by(id_via) %>%
summarise(Stages = n(),
MaxTravelTime = max(TravelTime),
TotalTravelTime = sum(TravelTime)) %>%
ungroup()
View(Temp_UniqueTrips)
View(Temp_UniqueTrips)
Trips_MainMode %<>% group_by(id_via, Mode) %>%
summarise(Stages = mean(Stages),
MaxTravelTime = sum(MaxTravelTime)) %>% ungroup()
TripsStages2 <- TripsStages %>%
select(id_via, Mode = p5_14,
TT_Hours = p5_16_1_1, TT_Minutes = p5_16_1_2) %>%
mutate(TT_Hours = as.numeric(TT_Hours),
TT_Minutes = as.numeric(TT_Minutes)) %>%
filter(!TT_Hours == 99) %>% filter(!TT_Minutes == 99) %>%
filter(TT_Hours < 4) %>%  # Remove trips lasting more than 4 hours.
mutate(TravelTime = TT_Hours*60 + TT_Minutes)
Temp_UniqueTrips <- TripsStages2 %>% group_by(id_via) %>%
summarise(Stages = n(),
MaxTravelTime = max(TravelTime),
TotalTravelTime = sum(TravelTime)) %>%
ungroup()
Trips_MainMode <- Temp_UniqueTrips %>%
left_join(TripsStages2,
by = c("id_via" = "id_via", "MaxTravelTime" = "TravelTime"))
View(Temp_UniqueTrips)
View(Trips_MainMode)
Trips_MainMode %<>% group_by(id_via, Mode) %>%
summarise(Stages = mean(Stages),
MaxTravelTime = sum(MaxTravelTime)) %>% ungroup()
View(Trips_MainMode)
View(Trips_MainMode)
dim(Trips_MainMode_PROBLEMATIC)
dim(Trips_MainMode) # 542291
dim(Trips)
Trips_MainMode_PROBLEMATIC <- Trips_MainMode %>%
group_by(id_via) %>%
summarise(TotalEqual = n()) %>%
filter(TotalEqual>1) %>% ungroup()
View(Trips_MainMode_PROBLEMATIC)
View(Trips_MainMode_PROBLEMATIC)
TripsStages2 <- TripsStages %>%
select(id_via, Mode = p5_14,
TT_Hours = p5_16_1_1, TT_Minutes = p5_16_1_2) %>%
mutate(TT_Hours = as.numeric(TT_Hours),
TT_Minutes = as.numeric(TT_Minutes)) %>%
filter(!TT_Hours == 99) %>% filter(!TT_Minutes == 99) %>%
filter(TT_Hours < 4) %>%  # Remove trips lasting more than 4 hours.
mutate(TravelTime = TT_Hours*60 + TT_Minutes)
TripsStages2
View(TripsStages2)
View(TripsStages2)
Temp_UniqueTrips <- TripsStages2 %>% group_by(id_via) %>%
summarise(Stages = n(),
MaxTravelTime = max(TravelTime),
TotalTravelTime = sum(TravelTime)) %>%
ungroup()
View(Temp_UniqueTrips)
View(Temp_UniqueTrips)
dim(TripsStages2)
dim(TripsStages2)
dim(Temp_UniqueTrips)
Trips_MainMode <- Temp_UniqueTrips %>%
left_join(TripsStages2,
by = c("id_via" = "id_via", "MaxTravelTime" = "TravelTime"))
dim(Trips_MainMode)
rm(list = ls())
library(tidyverse)
library(magrittr)
library(sf)
Trips <- read_delim(
"Mexico OD Survey/eod_2017_csv/tviaje_eod2017/conjunto_de_datos/tviaje.csv",
delim = ",")
#p5_11: HomeTrip or not
#p5_13: Trip Purpose
#p5_9_1: Time the trip started
PurposeNames <- data.frame(p5_13 = c(1:10,99),
Purpose = c("Hogar","Trabajar", "Estudiar",
"Otro", "Recreacion","Otro", "Otro",
"Salud", rep("Otro",3)))
TripsStages <- read_delim(
"Mexico OD Survey/eod_2017_csv/ttransporte_eod2017/conjunto_de_datos/ttransporte.csv",
delim = ",")
# id_via is the unique identifier. It is consistent with Trips
# p5_14 is the transport mode
# p5_16 is the order of the stages.
ModesNames <- data.frame(p5_14 = seq(1:20),
Modes = c("Automovil", "Colectivo/Micro", "Taxi(App internet)",
"Taxi (sitio, calle u otro)", "Metro", "Autobús RTP o M1",
"Bicicleta",  "Autobus", "Moto",  "Trolebus",
"Metrobus o Mexibus", "Tren ligero","Tren suburbano",
"Caminar en la calle", "Mexicable", "Bicitaxi",  "Mototaxi",
"Transporte escolar", "Transporte de personal", "Otro"))
Home <- read_delim(
"Mexico OD Survey/eod_2017_csv/thogar_eod2017/conjunto_de_datos/thogar.csv",
delim = ",")
Zones <- st_read("Mexico OD Survey/DistritosEODHogaresZMVM2017/DistritosEODHogaresZMVM2017.shp")
ZonesStations <- st_read("GTFS_March_2017/ZonesStations.shp")
ZonesStations %<>% st_set_geometry(NULL) %>% select(Distrito, NUMPOINTS)
names(ZonesStations) <- c("distrito", "Stations")
names(TripsStages)
names(Trips)
TripsStages2 <- TripsStages %>%
select(id_via, Mode = p5_14,
TT_Hours = p5_16_1_1, TT_Minutes = p5_16_1_2) %>%
mutate(TT_Hours = as.numeric(TT_Hours),
TT_Minutes = as.numeric(TT_Minutes)) %>%
filter(!TT_Hours == 99) %>% filter(!TT_Minutes == 99) %>%
filter(TT_Hours < 4) %>%  # Remove trips lasting more than 4 hours.
mutate(TravelTime = TT_Hours*60 + TT_Minutes)
head(TripsStages2)
names(TripsStages2)
Temp_UniqueTrips <- TripsStages2 %>% group_by(id_via) %>%
summarise(Stages = n(),
MaxTravelTime = max(TravelTime),
TotalTravelTime = sum(TravelTime)) %>%
ungroup()
View(Temp_UniqueTrips)
View(Temp_UniqueTrips)
View(TripsStages2)
View(TripsStages2)
Trips_MainMode <- Temp_UniqueTrips %>%
left_join(TripsStages2,
by = c("id_via" = "id_via", "MaxTravelTime" = "TravelTime"))
View(Trips_MainMode)
View(Trips_MainMode)
TripsStages2 <- TripsStages %>%
select(id_via, Mode = p5_14,
TT_Hours = p5_16_1_1, TT_Minutes = p5_16_1_2) %>%
mutate(TT_Hours = as.numeric(TT_Hours),
TT_Minutes = as.numeric(TT_Minutes)) %>%
filter(!TT_Hours == 99) %>% filter(!TT_Minutes == 99) %>%
filter(TT_Hours < 4) %>%  # Remove trips lasting more than 4 hours.
mutate(TravelTime = TT_Hours*60 + TT_Minutes)
# dim(TripsStages2) # We ended up with 880325 trip-stages.
Temp_UniqueTrips <- TripsStages2 %>% group_by(id_via) %>%
summarise(Stages = n(),
MaxTravelTime = max(TravelTime),
TotalTravelTime = sum(TravelTime)) %>%
ungroup()
# dim(Temp_UniqueTrips) # There are 527261
Trips_MainMode <- Temp_UniqueTrips %>%
left_join(TripsStages2,
by = c("id_via" = "id_via", "MaxTravelTime" = "TravelTime"))
# dim(Trips_MainMode) # 549282
# We have trips with stages that last the same (so there is not main mode)
# There are some trips-stages with the same mode. So:
Trips_MainMode %<>% group_by(id_via, Mode) %>%
summarise(Stages = mean(Stages),
MaxTravelTime = sum(MaxTravelTime)) %>% ungroup()
# dim(Trips_MainMode) # 542291
Trips_MainMode_PROBLEMATIC <- Trips_MainMode %>%
group_by(id_via) %>%
summarise(TotalEqual = n()) %>%
filter(TotalEqual>1) %>% ungroup()
# dim(Trips_MainMode_PROBLEMATIC)
# There are 14561 trips out of 527261 without a "main" transport mode.
Trips_MainMode %<>% filter(!id_via %in% Trips_MainMode_PROBLEMATIC$id_via) %>%
select(id_via, MainMode = Mode, Stages) %>%
left_join(Temp_UniqueTrips %>% select(id_via, TotalTravelTime)) %>%
left_join(Trips %>% select(id_via, id_soc, p5_3, factor))
# summary(as.factor(Trips_MainMode$p5_3))  # No NA values.
Trips_MainMode %<>%
mutate(MainMode = as.numeric(MainMode)) %>%
left_join(ModesNames, by = c("MainMode"="p5_14")) %>%
mutate(Day = if_else(p5_3 == 1, "Weekday", "Saturday"))
View(Trips_MainMode)
View(Trips_MainMode)
View(People)
People <- read_delim(
"Mexico OD Survey/eod_2017_csv/tsdem_eod2017/conjunto_de_datos/tsdem.csv",
delim = ",")
#id_soc is the unique identifier por people
View(People)
View(Trips_MainMode)
View(Trips_MainMode)
View(Trips)
View(Trips)
View(People)
View(People)
View(Home)
View(Home)
setwd("C:/Users/Orlan/Dropbox/Teaching/SpatialAnalysis/Tutorials/03_MexicoCity_HTS")
rm(list = ls())
plot(st_geometry(Zones))
library(tidyverse)
library(magrittr)
library(sf)
Zones <- st_read("Mexico OD Survey/DistritosEODHogaresZMVM2017/DistritosEODHogaresZMVM2017.shp")
Trips <- read_delim(
"Mexico OD Survey/eod_2017_csv/tviaje_eod2017/conjunto_de_datos/tviaje.csv",
delim = ",")
#p5_11: HomeTrip or not
#p5_13: Trip Purpose
#p5_9_1: Time the trip started
PurposeNames <- data.frame(p5_13 = c(1:10,99),
Purpose = c("Hogar","Trabajar", "Estudiar",
"Otro", "Recreacion","Otro", "Otro",
"Salud", rep("Otro",3)))
TripsStages <- read_delim(
"Mexico OD Survey/eod_2017_csv/ttransporte_eod2017/conjunto_de_datos/ttransporte.csv",
delim = ",")
# id_via is the unique identifier. It is consistent with Trips
# p5_14 is the transport mode
# p5_16 is the order of the stages.
ModesNames <- data.frame(p5_14 = seq(1:20),
Modes = c("Automovil", "Colectivo/Micro", "Taxi(App internet)",
"Taxi (sitio, calle u otro)", "Metro", "Autobús RTP o M1",
"Bicicleta",  "Autobus", "Moto",  "Trolebus",
"Metrobus o Mexibus", "Tren ligero","Tren suburbano",
"Caminar en la calle", "Mexicable", "Bicitaxi",  "Mototaxi",
"Transporte escolar", "Transporte de personal", "Otro"))
People <- read_delim(
"Mexico OD Survey/eod_2017_csv/tsdem_eod2017/conjunto_de_datos/tsdem.csv",
delim = ",")
#id_soc is the unique identifier por people
Home <- read_delim(
"Mexico OD Survey/eod_2017_csv/thogar_eod2017/conjunto_de_datos/thogar.csv",
delim = ",")
plot(st_geometry(Zones))
dim(Trips)
dim(TripsStages)
names(Trips)
names(TripsStages)
dim(People)
dim(Home)
names(People)
names(Home)
